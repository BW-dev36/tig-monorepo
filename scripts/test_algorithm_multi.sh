#!/bin/bash
export REPO_DIR=$(dirname $(dirname "$(realpath "$0")"))
export TIG_WORKER_PATH="$REPO_DIR/target/release/tig-worker"
export CHALLENGE="vector_search"
export ALGORITHM="kd_fastdim"
export CHALLENGE_ID="c004"
export debug_mode=true

start_nonce=3536738720
num_nonces=32

declare -a difficulties=(
            "[14, 505]"
            "[16, 490]"
            "[10, 511]"
            "[10, 520]"
            "[22, 459]"
            "[23, 452]"
            "[15, 501]"
            "[26, 446]"
            "[13, 513]"
            "[27, 440]"
            "[22, 457]"
            "[12, 508]"
            "[20, 475]"
            "[29, 435]"
            "[20, 467]"
            "[18, 478]"
            "[29, 428]"
            "[12, 513]"
            "[18, 480]"
            "[12, 512]"
            "[15, 497]"
            "[22, 462]"
            "[27, 438]"
            "[11, 517]"
            "[20, 468]"
            "[17, 488]"
            "[16, 491]"
            "[21, 467]"
            "[12, 517]"
            "[13, 511]"
            "[19, 482]"
            "[17, 487]"
            "[28, 439]"
            "[27, 437]"
            "[22, 454]"
            "[30, 428]"
            "[19, 472]"
            "[26, 452]"
            "[34, 420]"
            "[28, 433]"
            "[29, 432]"
            "[14, 502]"
            "[31, 422]"
            "[25, 446]"
            "[19, 475]"
            "[14, 507]"
            "[20, 472]"
            "[25, 448]"
            "[10, 514]"
            "[31, 421]"
            "[21, 469]"
            "[23, 455]"
            "[27, 442]"
            "[25, 447]"
            "[20, 466]"
            "[16, 501]"
            "[28, 437]"
            "[11, 518]"
            "[32, 421]"
            "[21, 472]"
            "[30, 429]"
            "[10, 515]"
            "[24, 449]"
            "[21, 466]"
            "[16, 496]"
            "[14, 511]"
            "[26, 451]"
            "[23, 456]"
            "[19, 478]"
            "[26, 443]"
            "[30, 427]"
            "[17, 486]"
            "[15, 499]"
            "[25, 453]"
            "[13, 505]"
            "[16, 493]"
            "[29, 437]"
            "[31, 425]"
            "[32, 420]"
            "[15, 504]"
            "[18, 484]"
            "[28, 432]"
            "[30, 432]"
            "[12, 514]"
            "[27, 441]"
            "[12, 516]"
            "[15, 498]"
            "[11, 512]"
            "[27, 445]"
            "[16, 495]"
            "[21, 465]"
            "[15, 507]"
            "[33, 421]"
            "[30, 431]"
            "[16, 492]"
            "[18, 483]"
            "[18, 477]"
            "[10, 510]"
            "[28, 438]"
            "[11, 515]"
            "[22, 460]"
            "[24, 453]"
            "[21, 468]"
            "[14, 509]"
            "[22, 456]"
            "[21, 461]"
            "[25, 455]"
            "[11, 510]"
            "[20, 471]"
            "[27, 435]"
            "[16, 500]"
            "[29, 431]"
            "[10, 512]"
            "[26, 441]"
            "[22, 458]"
            "[19, 474]"
            "[25, 445]"
            "[19, 476]"
            "[11, 514]"
            "[11, 519]"
            "[30, 426]"
            "[15, 509]"
            "[13, 506]"
            "[24, 446]"
            "[24, 452]"
            "[13, 507]"
            "[12, 515]"
            "[17, 494]"
            "[20, 469]"
            "[17, 485]"
            "[14, 506]"
            "[24, 454]"
            "[20, 473]"
            "[10, 516]"
            "[13, 514]"
            "[24, 447]"
            "[28, 436]"
            "[22, 453]"
            "[29, 433]"
            "[31, 426]"
            "[26, 449]"
            "[27, 439]"
            "[12, 511]"
            "[19, 481]"
            "[12, 509]"
            "[18, 479]"
            "[28, 434]"
            "[25, 450]"
            "[17, 491]"
            "[17, 489]"
            "[15, 502]"
            "[15, 496]"
            "[28, 431]"
            "[29, 430]"
            "[24, 455]"
            "[21, 475]"
            "[10, 517]"
            "[13, 512]"
            "[25, 451]"
            "[21, 470]"
            "[22, 466]"
            "[30, 424]"
            "[27, 443]"
            "[30, 423]"
            "[10, 519]"
            "[21, 464]"
            "[17, 484]"
            "[33, 420]"
            "[27, 436]"
            "[30, 433]"
            "[28, 435]"
            "[13, 504]"
            "[16, 499]"
            "[25, 452]"
            "[24, 456]"
            "[11, 509]"
            "[26, 448]"
            "[24, 451]"
            "[29, 429]"
            "[17, 483]"
            "[17, 490]"
            "[26, 444]"
            "[28, 441]"
            "[11, 516]"
            "[24, 448]"
            "[19, 477]"
            "[31, 420]"
            "[12, 518]"
            "[29, 436]"
            "[14, 504]"
            "[29, 434]"
            "[22, 455]"
            "[19, 473]"
            "[13, 509]"
            "[14, 503]"
            "[11, 513]"
            "[14, 508]"
            "[15, 512]"
            "[18, 475]"
            "[15, 500]"
            "[19, 479]"
            "[23, 457]"
            "[23, 454]"
            "[23, 453]"
            "[12, 510]"
            "[18, 481]"
            "[14, 501]"
            "[30, 425]"
            "[27, 444]"
            "[10, 518]"
            "[30, 430]"
            "[19, 480]"
            "[23, 451]"
            "[16, 489]"
            "[17, 496]"
            "[29, 439]"
            "[20, 474]"
            "[31, 423]"
            "[20, 470]"
            "[25, 444]"
            "[18, 482]"
            "[26, 445]"
            "[11, 511]"
            "[26, 442]"
            "[13, 508]"
            "[24, 450]"
            "[18, 476]"
            "[31, 424]"
            "[16, 494]"
            "[28, 440]"
            "[10, 513]"
            "[21, 462]"
            "[22, 461]"
            "[18, 474]"
            "[13, 510]"
            "[23, 459]"
            "[26, 447]"
            "[25, 449]"
)

process_nonce() {
    difficulty=$1
    nonce=$2

    SETTINGS="{\"challenge_id\":\"$CHALLENGE_ID\",\"difficulty\":$difficulty,\"algorithm_id\":\"\",\"player_id\":\"\",\"block_id\":\"\"}"
    num_solutions=0
    num_invalid=0
    num_errors=0
    total_ms=0

    start_time=$(date +%s%3N)
    stdout=$(mktemp)
    stderr=$(mktemp)
    $TIG_WORKER_PATH compute_solution --fuel 10000000000 "$SETTINGS" $nonce $REPO_DIR/tig-algorithms/wasm/$CHALLENGE/$ALGORITHM.wasm
    exit_code=$?
    output_stdout=$(cat "$stdout")
    output_stderr=$(cat "$stderr")
    end_time=$(date +%s%3N)
    duration=$((end_time - start_time))
    total_ms=$((total_ms + duration))

    if [ $exit_code -eq 0 ]; then
        num_solutions=$((num_solutions + 1))
    else
        if echo "$output_stderr" | grep -q "Invalid solution\|No solution found"; then
            num_invalid=$((num_invalid + 1))
        else
            num_errors=$((num_errors + 1))
        fi
    fi

    if [ $((num_solutions)) -eq 0 ]; then
        avg_ms_per_solution=0
    else
        avg_ms_per_solution=$((total_ms / num_solutions))
    fi

    if [[ $debug_mode == true ]]; then
        echo "$difficulty;$nonce;$num_solutions;$num_invalid;$num_errors;$duration;$output_stdout;$output_stderr;"
    else
        echo -ne "#instances: $((num_solutions + num_invalid + num_errors)), #solutions: $num_solutions, #invalid: $num_invalid, #errors: $num_errors, average ms/solution: $avg_ms_per_solution\033[K\r"
    fi
}

export -f process_nonce

for difficulty in "${difficulties[@]}"; do
    seq $start_nonce $((start_nonce + num_nonces - 1)) | parallel -j 1 process_nonce "'$difficulty'" {}
done
