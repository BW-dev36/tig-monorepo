#!/bin/bash
export REPO_DIR=$(dirname $(dirname "$(realpath "$0")"))
export TIG_WORKER_PATH="$REPO_DIR/target/release/tig-worker"
export CHALLENGE="vector_search"
export ALGORITHM="kd_fastdim"
export CHALLENGE_ID="c004"
export debug_mode=true

start_nonce=3536738720
num_nonces=32

declare -a difficulties=(
          "[28, 481]"
          "[30, 473]"
          "[22, 482]"
          "[46, 427]"
          "[29, 473]"
          "[46, 434]"
          "[27, 476]"
          "[38, 457]"
          "[28, 480]"
          "[37, 448]"
          "[30, 469]"
          "[35, 462]"
          "[24, 482]"
          "[32, 465]"
          "[46, 432]"
          "[33, 466]"
          "[40, 444]"
          "[45, 425]"
          "[49, 423]"
          "[50, 423]"
          "[42, 438]"
          "[33, 469]"
          "[24, 481]"
          "[32, 466]"
          "[27, 478]"
          "[49, 421]"
          "[44, 429]"
          "[31, 473]"
          "[30, 471]"
          "[47, 421]"
          "[31, 468]"
          "[22, 481]"
          "[24, 479]"
          "[30, 477]"
          "[36, 455]"
          "[23, 486]"
          "[21, 486]"
          "[31, 472]"
          "[48, 421]"
          "[27, 480]"
          "[37, 451]"
          "[49, 420]"
          "[24, 484]"
          "[39, 448]"
          "[31, 471]"
          "[37, 449]"
          "[25, 479]"
          "[37, 450]"
          "[26, 480]"
          "[35, 456]"
          "[49, 422]"
          "[29, 477]"
          "[39, 450]"
          "[29, 481]"
          "[48, 424]"
          "[29, 471]"
          "[43, 441]"
          "[47, 422]"
          "[22, 488]"
          "[53, 420]"
          "[34, 460]"
          "[36, 453]"
          "[25, 485]"
          "[42, 443]"
          "[45, 429]"
          "[24, 480]"
          "[32, 468]"
          "[41, 439]"
          "[28, 478]"
          "[44, 428]"
          "[33, 471]"
          "[34, 456]"
          "[37, 460]"
          "[39, 445]"
          "[25, 482]"
          "[23, 482]"
          "[39, 443]"
          "[25, 484]"
          "[44, 434]"
          "[41, 445]"
          "[30, 472]"
          "[27, 479]"
          "[40, 449]"
          "[41, 438]"
          "[50, 420]"
          "[29, 472]"
          "[45, 430]"
          "[25, 481]"
          "[26, 477]"
          "[34, 464]"
          "[32, 469]"
          "[45, 433]"
          "[33, 467]"
          "[37, 453]"
          "[43, 432]"
          "[39, 444]"
          "[25, 478]"
          "[48, 420]"
          "[29, 480]"
          "[45, 431]"
          "[42, 436]"
          "[22, 483]"
          "[36, 457]"
          "[35, 458]"
          "[20, 486]"
          "[41, 442]"
          "[37, 456]"
          "[34, 459]"
          "[41, 440]"
          "[40, 442]"
          "[28, 477]"
          "[38, 445]"
          "[48, 423]"
          "[28, 476]"
          "[21, 489]"
          "[22, 485]"
          "[43, 435]"
          "[27, 481]"
          "[28, 483]"
          "[22, 486]"
          "[33, 470]"
          "[35, 464]"
          "[37, 458]"
          "[44, 430]"
          "[39, 447]"
          "[41, 437]"
          "[30, 474]"
          "[46, 430]"
          "[36, 459]"
          "[42, 441]"
          "[23, 485]"
          "[29, 474]"
          "[20, 482]"
          "[40, 443]"
          "[33, 465]"
          "[32, 467]"
          "[44, 437]"
          "[47, 426]"
          "[40, 441]"
          "[35, 465]"
          "[36, 460]"
          "[38, 450]"
          "[36, 451]"
          "[21, 482]"
          "[26, 481]"
          "[38, 449]"
          "[36, 454]"
          "[31, 476]"
          "[47, 423]"
          "[28, 479]"
          "[40, 448]"
          "[43, 431]"
          "[42, 442]"
          "[47, 420]"
          "[30, 468]"
          "[30, 476]"
          "[38, 446]"
          "[35, 457]"
          "[52, 420]"
          "[46, 428]"
          "[38, 456]"
          "[26, 479]"
          "[21, 487]"
          "[38, 452]"
          "[24, 483]"
          "[45, 428]"
          "[34, 458]"
          "[20, 488]"
          "[42, 437]"
          "[21, 484]"
          "[33, 468]"
          "[20, 490]"
          "[48, 422]"
          "[37, 454]"
          "[35, 455]"
          "[46, 423]"
          "[20, 487]"
          "[39, 451]"
          "[47, 425]"
          "[47, 424]"
          "[42, 434]"
          "[28, 475]"
          "[42, 439]"
          "[44, 439]"
          "[26, 483]"
          "[27, 477]"
          "[23, 483]"
          "[40, 446]"
          "[26, 484]"
          "[31, 474]"
          "[33, 462]"
          "[35, 459]"
          "[39, 449]"
          "[36, 452]"
          "[29, 476]"
          "[45, 437]"
          "[46, 429]"
          "[20, 484]"
          "[41, 436]"
          "[44, 431]"
          "[20, 491]"
          "[22, 484]"
          "[38, 447]"
          "[32, 463]"
          "[32, 472]"
          "[34, 457]"
          "[31, 467]"
          "[35, 461]"
          "[31, 475]"
          "[47, 428]"
          "[30, 478]"
          "[21, 485]"
          "[43, 433]"
          "[29, 478]"
          "[22, 487]"
          "[20, 483]"
          "[34, 465]"
          "[21, 490]"
          "[48, 426]"
          "[30, 470]"
          "[33, 463]"
          "[41, 441]"
          "[44, 427]"
          "[24, 485]"
          "[45, 432]"
          "[27, 482]"
          "[38, 451]"
          "[51, 420]"
          "[23, 484]"
          "[39, 446]"
          "[46, 424]"
          "[29, 475]"
          "[21, 488]"
          "[31, 470]"
          "[35, 460]"
          "[25, 480]"
          "[42, 440]"
          "[43, 439]"
          "[43, 434]"
          "[32, 470]"
          "[32, 464]"
          "[41, 446]"
          "[45, 427]"
          "[43, 429]"
          "[38, 444]"
          "[20, 489]"
          "[43, 430]"
          "[43, 436]"
          "[33, 464]"
          "[28, 484]"
          "[24, 486]"
          "[46, 433]"
          "[46, 426]"
          "[36, 458]"
          "[31, 469]"
          "[21, 483]"
          "[39, 454]"
          "[25, 483]"
          "[42, 435]"
          "[47, 427]"
          "[23, 480]"
          "[26, 478]"
          "[23, 481]"
          "[32, 471]"
          "[28, 482]"
          "[20, 485]"
          "[50, 421]"
)

process_nonce() {
    difficulty=$1
    nonce=$2

    SETTINGS="{\"challenge_id\":\"$CHALLENGE_ID\",\"difficulty\":$difficulty,\"algorithm_id\":\"\",\"player_id\":\"\",\"block_id\":\"\"}"
    num_solutions=0
    num_invalid=0
    num_errors=0
    total_ms=0

    start_time=$(date +%s%3N)
    stdout=$(mktemp)
    stderr=$(mktemp)
    $TIG_WORKER_PATH compute_solution --fuel 10000000000 "$SETTINGS" $nonce $REPO_DIR/tig-algorithms/wasm/$CHALLENGE/$ALGORITHM.wasm
    exit_code=$?
    output_stdout=$(cat "$stdout")
    output_stderr=$(cat "$stderr")
    end_time=$(date +%s%3N)
    duration=$((end_time - start_time))
    total_ms=$((total_ms + duration))

    if [ $exit_code -eq 0 ]; then
        num_solutions=$((num_solutions + 1))
    else
        if echo "$output_stderr" | grep -q "Invalid solution\|No solution found"; then
            num_invalid=$((num_invalid + 1))
        else
            num_errors=$((num_errors + 1))
        fi
    fi

    if [ $((num_solutions)) -eq 0 ]; then
        avg_ms_per_solution=0
    else
        avg_ms_per_solution=$((total_ms / num_solutions))
    fi

    if [[ $debug_mode == true ]]; then
        echo "$difficulty;$nonce;$num_solutions;$num_invalid;$num_errors;$duration;$output_stdout;$output_stderr;"
    else
        echo -ne "#instances: $((num_solutions + num_invalid + num_errors)), #solutions: $num_solutions, #invalid: $num_invalid, #errors: $num_errors, average ms/solution: $avg_ms_per_solution\033[K\r"
    fi
}

export -f process_nonce

for difficulty in "${difficulties[@]}"; do
    seq $start_nonce $((start_nonce + num_nonces - 1)) | parallel -j 1 process_nonce "'$difficulty'" {}
done
